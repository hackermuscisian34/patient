<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Tracking Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <style>
        #map { height: 500px; }
        .alert-item { cursor: pointer; }
        .alert-item:hover { background-color: #f8f9fa; }
        .status-online { color: green; }
        .status-offline { color: red; }
        .geofence-circle { stroke: red; fill: red; fill-opacity: 0.1; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">Patient Tracking System</h1>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">System Status</h5>
                        <p id="system-status" class="card-text">
                            <span class="status-offline">●</span> Offline
                        </p>
                        <small id="last-update">No data</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Geofence</h5>
                        <p id="geofence-status" class="card-text">
                            <span class="text-warning">●</span> Unknown
                        </p>
                        <small id="geofence-distance">Checking...</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Active Alerts</h5>
                        <h3 id="alert-count" class="text-danger">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Locations (24h)</h5>
                        <h3 id="location-count">0</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Live Location Map</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Recent Alerts</h5>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        <div id="alerts-list">
                            <p class="text-muted">No alerts</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Location History</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="location-chart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize map
        let map = L.map('map').setView([40.7128, -74.006], 15);
        let currentMarker = null;
        let geofenceCircle = null;
        let pathPolyline = null;
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Update functions
        async function updateCurrentLocation() {
            try {
                const response = await fetch('/api/current_location');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('system-status').innerHTML = 
                        '<span class="status-offline">●</span> Offline';
                    return;
                }
                
                // Update status
                document.getElementById('system-status').innerHTML = 
                    '<span class="status-online">●</span> Online';
                
                const updateTime = new Date(data.timestamp);
                document.getElementById('last-update').textContent = 
                    `Last update: ${updateTime.toLocaleString()}`;
                
                // Update map marker
                const latlng = [data.latitude, data.longitude];
                
                if (currentMarker) {
                    currentMarker.setLatLng(latlng);
                } else {
                    currentMarker = L.marker(latlng).addTo(map)
                        .bindPopup(`Patient Location<br>Speed: ${data.speed || 0} km/h<br>Accuracy: ${data.accuracy || 0}m`);
                }
                
                map.setView(latlng, 15);
                
            } catch (error) {
                console.error('Error updating location:', error);
            }
        }

        async function updateGeofence() {
            try {
                const response = await fetch('/api/geofence_status');
                const data = await response.json();
                
                if (!data.enabled) {
                    document.getElementById('geofence-status').innerHTML = 
                        '<span class="text-secondary">●</span> Disabled';
                    return;
                }
                
                const statusClass = data.status === 'within' ? 'text-success' : 'text-danger';
                const statusText = data.status === 'within' ? 'Within' : 'Outside';
                
                document.getElementById('geofence-status').innerHTML = 
                    `<span class="${statusClass}">●</span> ${statusText}`;
                
                document.getElementById('geofence-distance').textContent = 
                    `Distance: ${Math.round(data.distance)}m / ${data.radius}m`;
                
                // Update geofence circle on map
                if (geofenceCircle) {
                    geofenceCircle.remove();
                }
                
                geofenceCircle = L.circle([data.center.latitude, data.center.longitude], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.1,
                    radius: data.radius
                }).addTo(map);
                
            } catch (error) {
                console.error('Error updating geofence:', error);
            }
        }

        async function updateAlerts() {
            try {
                const response = await fetch('/api/alerts');
                const alerts = await response.json();
                
                document.getElementById('alert-count').textContent = alerts.length;
                
                const alertsList = document.getElementById('alerts-list');
                
                if (alerts.length === 0) {
                    alertsList.innerHTML = '<p class="text-muted">No alerts</p>';
                    return;
                }
                
                alertsList.innerHTML = alerts.map(alert => `
                    <div class="alert-item border-bottom p-2" onclick="resolveAlert(${alert.id})">
                        <div class="d-flex justify-content-between">
                            <strong>${alert.alert_type}</strong>
                            <small>${new Date(alert.timestamp).toLocaleString()}</small>
                        </div>
                        <div>${alert.message}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error updating alerts:', error);
            }
        }

        async function updateStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const stats = await response.json();
                
                document.getElementById('location-count').textContent = stats.recent_locations_24h;
                
            } catch (error) {
                console.error('Error updating statistics:', error);
            }
        }

        async function updateLocationHistory() {
            try {
                const response = await fetch('/api/location_history?hours=24');
                const locations = await response.json();
                
                if (locations.length < 2) return;
                
                // Update path on map
                const pathPoints = locations.map(loc => [loc.latitude, loc.longitude]);
                
                if (pathPolyline) {
                    pathPolyline.remove();
                }
                
                pathPolyline = L.polyline(pathPoints, {
                    color: 'blue',
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);
                
                // Update chart
                const ctx = document.getElementById('location-chart').getContext('2d');
                
                const labels = locations.map(loc => 
                    new Date(loc.timestamp).toLocaleTimeString()
                );
                const speedData = locations.map(loc => loc.speed || 0);
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Speed (km/h)',
                            data: speedData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error updating location history:', error);
            }
        }

        async function resolveAlert(alertId) {
            try {
                await fetch('/api/mark_alert_resolved', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ alert_id: alertId })
                });
                
                updateAlerts();
                
            } catch (error) {
                console.error('Error resolving alert:', error);
            }
        }

        // Auto-update every 30 seconds
        function updateAll() {
            updateCurrentLocation();
            updateGeofence();
            updateAlerts();
            updateStatistics();
        }

        // Initial load
        updateAll();
        updateLocationHistory();
        
        // Set intervals
        setInterval(updateAll, 30000); // 30 seconds
        setInterval(updateLocationHistory, 300000); // 5 minutes
    </script>
</body>
</html>
